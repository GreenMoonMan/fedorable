---
# Installs GNOME Shell extensions externally via gnome-extensions-cli ("gext") and enables them.

- name: Install prerequisites for managing GNOME extensions
  become: true
  ansible.builtin.dnf:
    name:
      - gnome-shell
      - unzip
      - dbus-daemon
      - dbus-tools
      - python3-pip
      - pipx
    state: present

# Use the Ansible collection module instead of shelling out to pipx directly.
# (It also honors PIPX_HOME / PIPX_BIN_DIR via the `environment:` keyword.)
- name: Ensure gnome-extensions-cli (gext) is installed via pipx for target user
  become: true
  become_user: "{{ extensions_dconf_target_user | default(ansible_user_id) }}"
  community.general.pipx:
    name: gnome-extensions-cli
    state: present
  environment:
    PIPX_HOME: "{{ (extensions_dconf_target_user_home | default('/home/' ~ (extensions_dconf_target_user | default(ansible_user_id)))) ~ '/.local/pipx' }}"
    PIPX_BIN_DIR: "{{ (extensions_dconf_target_user_home | default('/home/' ~ (extensions_dconf_target_user | default(ansible_user_id)))) ~ '/.local/bin' }}"

- name: Read currently enabled GNOME extensions (UUIDs)
  become: true
  become_user: "{{ extensions_dconf_target_user | default(ansible_user_id) }}"
  ansible.builtin.command:
    cmd: "dbus-run-session -- gnome-extensions list --enabled"
  register: extensions_enabled_uuids
  changed_when: false

- name: Install GNOME Shell extensions via gext (filesystem backend)
  become: true
  become_user: "{{ extensions_dconf_target_user | default(ansible_user_id) }}"
  ansible.builtin.command:
    cmd: "{{ (extensions_dconf_target_user_home | default('/home/' ~ (extensions_dconf_target_user | default(ansible_user_id)))) ~ '/.local/bin/gext' }} --filesystem install {{ item.pk }}"
  args:
    creates: >-
      {{ (extensions_dconf_target_user_home | default('/home/' ~ (extensions_dconf_target_user | default(ansible_user_id))))
         ~ '/.local/share/gnome-shell/extensions/' ~ item.uuid ~ '/metadata.json' }}
  loop: "{{ extensions_gnome_shell_extensions }}"
  loop_control:
    label: "{{ item.name }} (pk={{ item.pk }}, uuid={{ item.uuid }})"
