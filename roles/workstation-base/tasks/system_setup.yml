---
- name: Basic Fedora setup (RPM Fusion, codecs, AMD decode)
  become: true
  block:
    - name: Ensure this runs on Fedora
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] == "Fedora"
        fail_msg: "This task block is intended for Fedora hosts only."

    - name: Update all packages to latest
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
    
    - name: Import RPM Fusion Free GPG key
      ansible.builtin.rpm_key:
        state: present
        key: "https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-free-fedora-2020"

    - name: Import RPM Fusion Nonfree GPG key
      ansible.builtin.rpm_key:
        state: present
        key: "https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-nonfree-fedora-2020"

    - name: Enable RPM Fusion repositories (free and nonfree)
      ansible.builtin.dnf:
        name:
          - "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_facts['distribution_major_version'] }}.noarch.rpm"
          - "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_facts['distribution_major_version'] }}.noarch.rpm"
        state: present

    # update the core group after installing rpm fusion
    - name: Upgrade @core group
      ansible.builtin.dnf:
        name: "@core"
        state: latest

    # Equivalent to 
    # dnf -y swap ffmpeg-free ffmpeg --allowerasing
    - name: Enable full version of ffmpeg
      ansible.builtin.command: dnf -y swap ffmpeg-free ffmpeg --allowerasing
      register: dnf_swap_ffmpeg
      changed_when: "'Nothing to do' not in dnf_swap_ffmpeg.stdout"
      failed_when: dnf_swap_ffmpeg.rc != 0

    # Equivalent to:
    # dnf install -y gstreamer1-plugins-{bad-*,good-*,base} gstreamer1-plugin-openh264 gstreamer1-libav --exclude=...
    - name: Install GStreamer codecs and libav
      ansible.builtin.dnf:
        name:
          - gstreamer1-plugins-base
          - gstreamer1-plugins-good
          - gstreamer1-plugins-bad-free
          - gstreamer1-plugins-bad-free-extras
          - gstreamer1-plugin-openh264
          - gstreamer1-libav
        state: present
        exclude:
          - gstreamer1-plugins-bad-free-devel

    # Equivalent to: dnf install -y lame* --exclude=lame-devel
    - name: Install LAME (MP3 support)
      ansible.builtin.dnf:
        name:
          - lame
          - lame-libs
        state: present
        exclude:
          - lame-devel

    # upgrade multimedia group
    - name: Upgrade Multimedia group (with optional packages)
      ansible.builtin.dnf:
        name: "@Multimedia"
        state: latest

    # upgrade sound-and-video group
    - name: Upgrade sound-and-video group (with optional packages)
      ansible.builtin.dnf:
        name: "@sound-and-video"
        state: latest

    # Equivalent to:
    # dnf -y swap mesa-va-drivers mesa-va-drivers-freeworld
    # dnf -y swap mesa-vdpau-drivers mesa-vdpau-drivers-freeworld
    - name: Enable AMD hardware decode (VA-API freeworld)
      ansible.builtin.command: dnf -y swap mesa-va-drivers mesa-va-drivers-freeworld
      register: dnf_swap_va
      changed_when: "'Nothing to do' not in dnf_swap_va.stdout"
      failed_when: dnf_swap_va.rc != 0

    - name: Enable AMD hardware decode (VDPAU freeworld)
      ansible.builtin.command: dnf -y swap mesa-vdpau-drivers mesa-vdpau-drivers-freeworld
      register: dnf_swap_vdpau
      changed_when: "'Nothing to do' not in dnf_swap_vdpau.stdout"
      failed_when: dnf_swap_vdpau.rc != 0

    - name: Install libva-utils
      ansible.builtin.dnf:
        name: libva-utils
        state: present
